<!DOCTYPE html>
<html lang="en">
<head>
        <title>Replacing a Puppet CA Cert</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="./theme/css/main.css" type="text/css" />
                <link href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="zfs snapshot blkperl/dev/brain@Today Atom Feed" />
                
        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="./css/ie.css"/>
                <script src="./js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="./css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="./">zfs snapshot blkperl/dev/brain@Today </a></h1>
                <nav><ul>
                                                                                                    <li ><a href="./category/ganeti.html">ganeti</a></li>
                                    <li class="active"><a href="./category/puppet.html">puppet</a></li>
                                </ul></nav>
        </header><!-- /#banner -->
        <section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="./replace-puppet-ca.html" rel="bookmark"
           title="Permalink to Replacing a Puppet CA Cert">Replacing a Puppet CA Cert</a></h1>
      <a href="http://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="pdx_blkperl">Tweet</a><script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>
    </header>

    <div class="entry-content">
      <footer class="post-info">
        <abbr class="published" title="2013-03-26T22:50:00">
                Tue 26 March 2013
        </abbr>

                <address class="vcard author">
                By <a class="url fn" href="./author/william-van-hevelingen.html">William Van Hevelingen</a>
        </address>
        <p>In <a href="./category/puppet.html">puppet</a>. </p>
<p>tags: <a href="./tag/puppet.html">puppet</a><a href="./tag/openssl.html">openssl</a></p>
</footer><!-- /.post-info -->      <p>This is more of a story than a tutorial and I make no claims that this is the "correct" way to replace a Puppet CA cert but this is how we did it.</p>
<p>Our puppet ca cert was going to expire in about 18 hours so we set aside some time when no one else was working on other systems and madly searched the internet for tidbits of information to replace the cert.</p>
<p>In our environment we have a Puppet CA Server, a puppetmaster, and puppetdb/dashboard server and about 200 nix clients.</p>
<h2>Prep Work</h2>
<ul>
<li>Stop all puppet agents.</li>
</ul>
<p>If running the daemon the run <code>service puppet stop</code> on all the clients and if running by cron then disable all the puppet crons. This is not necessary but it will prevent the clients from spamming logs while your replace the certs. It may also prevent some clients from getting into a weird limbo state.</p>
<ul>
<li>Verify time is correct on all the puppetmasters.</li>
</ul>
<p>If the servers are not in sync then the certs generated will not work. I would recommend NTP if your not already running it to keep all your machines in sync.</p>
<h2>Generate a new CA Cert</h2>
<p>On the puppet ca remove the expired cert.</p>
<div class="codehilite"><pre><span class="n">rm</span> <span class="o">-</span><span class="n">rf</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">puppet</span><span class="o">/</span><span class="n">ssl</span>
</pre></div>


<p>Add any alternate dns names to /etc/puppet/puppet.conf</p>
<div class="codehilite"><pre><span class="n">dns_alt_names</span><span class="o">=</span><span class="n">puppetca</span><span class="p">,</span><span class="n">puppetca</span><span class="p">.</span><span class="n">cat</span><span class="p">.</span><span class="n">pdx</span><span class="p">.</span><span class="n">edu</span><span class="p">,</span><span class="n">zeratul</span><span class="p">.</span><span class="n">cat</span><span class="p">.</span><span class="n">pdx</span><span class="p">.</span><span class="n">edu</span><span class="p">,</span><span class="n">zeratul</span>
</pre></div>


<p>Review the puppet.conf docs for other CA settings you may want to set before moving on.</p>
<h2>Generate a new cert for the CA</h2>
<div class="codehilite"><pre><span class="n">puppet</span> <span class="n">cert</span> <span class="o">--</span><span class="n">generate</span> <span class="n">zeratul</span><span class="p">.</span><span class="n">cat</span><span class="p">.</span><span class="n">pdx</span><span class="p">.</span><span class="n">edu</span>
</pre></div>


<p>Verify the new ca.pem and ca cert look correct.</p>
<div class="codehilite"><pre><span class="n">openssl</span> <span class="n">x509</span> <span class="o">-</span><span class="n">text</span> <span class="o">-</span><span class="n">noout</span> <span class="o">-</span><span class="n">in</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">puppet</span><span class="o">/</span><span class="n">ssl</span><span class="o">/</span><span class="n">certs</span><span class="o">/</span><span class="n">ca</span><span class="p">.</span><span class="n">pem</span>
<span class="n">openssl</span> <span class="n">x509</span> <span class="o">-</span><span class="n">text</span> <span class="o">-</span><span class="n">noout</span> <span class="o">-</span><span class="n">in</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">puppet</span><span class="o">/</span><span class="n">ssl</span><span class="o">/</span><span class="n">certs</span><span class="o">/</span><span class="n">zeratul</span><span class="p">.</span><span class="n">cat</span><span class="p">.</span><span class="n">pdx</span><span class="p">.</span><span class="n">edu</span><span class="p">.</span><span class="n">pem</span>
</pre></div>


<p>Specifically, the validity field should now be 5 years in the future. You can set the expiration date in puppet.conf before you generate the cert if you want a longer or shorter period.</p>
<div class="codehilite"><pre><span class="err">$</span> <span class="n">openssl</span> <span class="n">x509</span> <span class="o">-</span><span class="n">text</span> <span class="o">-</span><span class="n">noout</span> <span class="o">-</span><span class="n">in</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">puppet</span><span class="o">/</span><span class="n">ssl</span><span class="o">/</span><span class="n">certs</span><span class="o">/</span><span class="n">ca</span><span class="p">.</span><span class="n">pem</span> <span class="o">|</span> <span class="n">grep</span> <span class="o">-</span><span class="n">i</span> <span class="n">validity</span> <span class="o">-</span><span class="n">A</span> <span class="mi">2</span>
        <span class="n">Validity</span>
            <span class="n">Not</span> <span class="n">Before</span><span class="o">:</span> <span class="n">Mar</span> <span class="mi">25</span> <span class="mo">03</span><span class="o">:</span><span class="mi">20</span><span class="o">:</span><span class="mi">40</span> <span class="mi">2013</span> <span class="n">GMT</span>
            <span class="n">Not</span> <span class="n">After</span> <span class="o">:</span> <span class="n">Mar</span> <span class="mi">25</span> <span class="mo">03</span><span class="o">:</span><span class="mi">20</span><span class="o">:</span><span class="mi">40</span> <span class="mi">2018</span> <span class="n">GMT</span>
</pre></div>


<p>Restart apache.</p>
<div class="codehilite"><pre><span class="n">service</span> <span class="n">apache2</span> <span class="n">restart</span>
</pre></div>


<h2>Generate a new cert for each puppet master</h2>
<div class="codehilite"><pre><span class="cp"># request a new cert on the puppetmaster</span>
<span class="n">puppet</span> <span class="n">agent</span> <span class="o">--</span><span class="n">test</span> <span class="o">--</span><span class="n">dns_alt_names</span><span class="o">=</span><span class="n">tassadar</span><span class="p">,</span><span class="n">tassadar</span><span class="p">.</span><span class="n">cat</span><span class="p">.</span><span class="n">pdx</span><span class="p">.</span><span class="n">edu</span><span class="p">,</span><span class="n">puppet</span><span class="p">,</span><span class="n">puppet</span><span class="p">.</span><span class="n">cat</span><span class="p">.</span><span class="n">pdx</span><span class="p">.</span><span class="n">edu</span>

<span class="cp"># on the ca server sign the cert</span>
<span class="n">puppet</span> <span class="n">cert</span> <span class="o">--</span><span class="n">allow</span><span class="o">-</span><span class="n">dns</span><span class="o">-</span><span class="n">alt</span><span class="o">-</span><span class="n">names</span> <span class="n">sign</span> <span class="n">tassadar</span><span class="p">.</span><span class="n">cat</span><span class="p">.</span><span class="n">pdx</span><span class="p">.</span><span class="n">edu</span>

<span class="cp"># restart apache on the puppet master</span>
<span class="n">service</span> <span class="n">apache2</span> <span class="n">restart</span>
</pre></div>


<p>At this point your puppet master if configured to be an agent of itself, should be able to run <code>puppet agent --test</code> with no errors unless you are running puppetdb.</p>
<h2>Generate a new cert for puppetdb</h2>
<p>The <a href="http://docs.puppetlabs.com/puppetdb/1.1/maintain_and_tune.html#redo-ssl-setup-after-changing-certificates">official docs</a> did not work for us. We had to add some additional steps documented below and we filed a <a href="https://projects.puppetlabs.com/issues/19904">bug</a> to update the docs or fix the <code>puppetdb-ssl-setup</code> command.</p>
<div class="codehilite"><pre><span class="cp"># Remove the old puppetdb certs on the puppetdb server</span>
<span class="n">rm</span> <span class="o">-</span><span class="n">rf</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">puppetdb</span><span class="o">/</span><span class="n">ssl</span>

<span class="cp"># Generate new puppetdb certs</span>
<span class="n">puppetdb</span><span class="o">-</span><span class="n">ssl</span><span class="o">-</span><span class="n">setup</span>

<span class="cp"># restart the service</span>
<span class="n">service</span> <span class="n">puppetdb</span> <span class="n">restart</span>

<span class="cp"># verify it restarts by watching the log (it may take a few minutes)</span>
<span class="n">tail</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">puppetdb</span><span class="o">/</span><span class="n">puppetdb</span><span class="p">.</span><span class="n">log</span>
</pre></div>


<p>At this point if you did everything correct, the puppetmaster should be able to checkin to itself as a client with no errors and be able to download a catalog.</p>
<h2>Request a cert for dashboard</h2>
<p>Excerpt from the <a href="http://docs.puppetlabs.com/dashboard/manual/1.2/configuring.html">official docs</a> for the 1.2 stable release of dashboard.</p>
<div class="codehilite"><pre><span class="cp"># on the dashboard server</span>
<span class="n">cd</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">puppet</span><span class="o">-</span><span class="n">dashboard</span>
<span class="n">rake</span> <span class="n">cert</span><span class="o">:</span><span class="n">request</span>

<span class="cp"># on the ca server</span>
<span class="n">puppet</span> <span class="n">cert</span> <span class="n">sign</span> <span class="n">dashboard</span>

<span class="cp"># restart apache on the dashboard server</span>
<span class="n">service</span> <span class="n">apache2</span> <span class="n">restart</span>
</pre></div>


<h2>Generate new certs for all your clients</h2>
<p>Note if any clients are offline during the process they will need a new cert generated and signed when they come back online.</p>
<p>We used a bash for loop that looked something like this.</p>
<div class="codehilite"><pre><span class="n">cat</span> <span class="n">alltheclients</span><span class="p">.</span><span class="n">txt</span> <span class="o">|</span> <span class="n">xargs</span> <span class="o">-</span><span class="n">P</span> <span class="mi">10</span> <span class="o">-</span><span class="n">n</span> <span class="mi">1</span> <span class="o">-</span><span class="n">I</span> <span class="n">box</span> <span class="n">ssh</span> <span class="o">-</span><span class="mi">4</span> <span class="n">box</span> <span class="err">&#39;</span><span class="n">rm</span> <span class="o">-</span><span class="n">fr</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">puppet</span><span class="o">/</span><span class="n">ssl</span> <span class="o">&amp;&amp;</span> <span class="n">puppet</span> <span class="n">agent</span> <span class="o">-</span><span class="n">t</span><span class="err">&#39;</span>
</pre></div>


<p>The key part in this bash one liner is removing <code>/var/lib/puppet/ssl</code> and requesting a new cert.</p>
<p>Then on the puppet ca server we signed the new certs</p>
<div class="codehilite"><pre><span class="cp"># For each client sign the new cert</span>
<span class="n">puppet</span> <span class="n">cert</span> <span class="n">sign</span> <span class="n">client2</span><span class="p">.</span><span class="n">cat</span><span class="p">.</span><span class="n">pdx</span><span class="p">.</span><span class="n">edu</span>
</pre></div>


<p>Or you can use the <code>--all</code> flag</p>
<p>There are some security risks with doing this. Basically for the same reasons on why not to use autosign. Read Brice's <a href="http://www.masterzen.fr/2010/11/14/puppet-ssl-explained/">blog</a> for more information about Puppet and SSl.</p>
<div class="codehilite"><pre><span class="n">puppet</span> <span class="n">cert</span> <span class="n">sign</span> <span class="o">--</span><span class="n">all</span>
</pre></div>


<h2>Summary</h2>
<p>This was a really painful process and is poorly documented. A lot of the clients were left in a broken state and needed to be kicked because the original for loop failed (probably because we didn't turn off the agents first). About 3 hours after we begun we had most of the clients working again and we fixed some stragglers the next day.</p>
<p>If someone has a better/easier process for doing this, please blog about it or submit a pull request to the <a href="http://docs.puppetlabs.com/contribute.html#editing-the-documentation">official docs</a>.</p>
    </div><!-- /.entry-content -->
    
  </article>
</section>
        <section id="extras" class="body">
                                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>
                            
                                                    <li><a href="http://twitter.com/pdx_blkperl">twitter</a></li>
                                                    <li><a href="http://github.com/blkperl">github</a></li>
                                                </ul>
                </div><!-- /.social -->
                </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>